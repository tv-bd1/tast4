<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ultimate IPTV Player PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        :root { --bg: #000; --card: #121212; --accent: #00E5FF; --fav: #FFD700; --text: #fff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* PLAYER AREA */
        .player-wrap { position: relative; width: 100%; background: #000; aspect-ratio: 16/9; flex-shrink: 0; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; z-index: 5; }

        /* LOADER */
        #loader { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); z-index: 200; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* CONTROLS */
        .controls-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; visibility: hidden; transition: 0.3s; z-index: 100; display: flex; flex-direction: column; justify-content: flex-end; }
        .controls-overlay.show { opacity: 1; visibility: visible; }
        .bottom-bar { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .mini-btns i { font-size: 1.5rem; cursor: pointer; color: #fff; }

        /* INFO & LIST */
        .info { padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; background: #0a0a0a; border-bottom: 1px solid #1a1a1a; }
        .mini-logo { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; }
        .list { flex: 1; overflow-y: auto; padding: 10px; background: #000; }
        .row { display: flex; align-items: center; gap: 12px; background: var(--card); padding: 10px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #1a1a1a; cursor: pointer; }
        .row.active { border-color: var(--accent); background: rgba(0, 229, 255, 0.1); }
        .list-logo { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }
        .name { flex: 1; font-size: 0.95rem; color: #fff; }
    </style>
</head>
<body>

<div class="player-wrap" id="playerArea" onclick="handlePlayerClick()">
    <div id="loader"><div class="spinner"></div></div>
    <video id="video" playsinline crossorigin="anonymous"></video>
    
    <div class="controls-overlay" id="controls">
        <div class="bottom-bar">
            <div class="mini-btns">
                <i class="fas fa-play" id="pp" onclick="togglePlay(event)"></i>
                <i class="fas fa-redo" style="margin-left: 20px;" onclick="location.reload()"></i>
            </div>
            <i class="fas fa-expand" onclick="toggleFull(event)"></i>
        </div>
    </div>
</div>

<div class="info">
    <div style="display:flex; align-items:center; gap:12px;">
        <img id="currentLogo" class="mini-logo" src="https://i.imgur.com/8Qf6Y0L.png">
        <div><h3 id="title" style="font-size:1rem;">চ্যানেল লোড হচ্ছে...</h3><small style="color:var(--accent);">LIVE STREAM</small></div>
    </div>
    <div id="count" style="font-size:0.85rem; opacity:0.8;">0 CH</div>
</div>

<div class="list" id="list"></div>

<script>
    const video = document.getElementById('video');
    const listArea = document.getElementById('list');
    const loader = document.getElementById('loader');
    const controls = document.getElementById('controls');
    let hls = new Hls();
    let allChannels = [];

    // প্লেয়ার ক্লিক হ্যান্ডলার
    function handlePlayerClick() {
        controls.classList.toggle('show');
    }

    // ভিডিও প্লে করার ফাংশন
    function play(url, name, logo) {
        loader.style.display = 'flex';
        document.getElementById('title').innerText = name;
        document.getElementById('currentLogo').src = logo || "https://i.imgur.com/8Qf6Y0L.png";

        if (Hls.isSupported()) {
            hls.destroy();
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play();
                loader.style.display = 'none';
            });
            // এরর হ্যান্ডলিং
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    console.error("HLS Fatal Error:", data.type);
                    loader.style.display = 'none';
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.play();
        }
        document.getElementById('pp').className = "fas fa-pause";
        renderList(url);
    }

    // চ্যানেল লিস্ট রেন্ডার করা
    function renderList(activeUrl) {
        listArea.innerHTML = "";
        document.getElementById('count').innerText = allChannels.length + " CH";
        allChannels.forEach(ch => {
            const isActive = (activeUrl === ch.url);
            const d = document.createElement('div');
            d.className = `row ${isActive ? 'active' : ''}`;
            d.innerHTML = `<img src="${ch.logo}" class="list-logo" onerror="this.src='https://i.imgur.com/8Qf6Y0L.png'"><div class="name">${ch.name}</div>`;
            d.onclick = () => play(ch.url, ch.name, ch.logo);
            listArea.appendChild(d);
        });
    }

    // প্লে/পজ বাটন
    function togglePlay(e) {
        e.stopPropagation();
        if (video.paused) {
            video.play();
            document.getElementById('pp').className = "fas fa-pause";
        } else {
            video.pause();
            document.getElementById('pp').className = "fas fa-play";
        }
    }

    // ফুল স্ক্রিন
    function toggleFull(e) {
        e.stopPropagation();
        if (!document.fullscreenElement) {
            document.getElementById('playerArea').requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    }

    // প্লেলিস্ট লোড করা (URL ?playlist= লিংকের মাধ্যমে)
    const playlistUrl = new URLSearchParams(location.search).get('playlist');

    if (playlistUrl) {
        fetch(playlistUrl)
            .then(res => res.text())
            .then(data => {
                const lines = data.split('\n');
                let currentChannel = {};
                allChannels = [];

                lines.forEach(line => {
                    line = line.trim();
                    if (line.startsWith('#EXTINF')) {
                        const nameMatch = line.split(',')[1];
                        const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                        currentChannel.name = nameMatch ? nameMatch.trim() : "Unknown Channel";
                        currentChannel.logo = logoMatch ? logoMatch[1] : "";
                    } else if (line.startsWith('http')) {
                        currentChannel.url = line;
                        allChannels.push({ ...currentChannel });
                        currentChannel = {};
                    }
                });

                if (allChannels.length > 0) {
                    renderList();
                    play(allChannels[0].url, allChannels[0].name, allChannels[0].logo);
                } else {
                    document.getElementById('title').innerText = "কোনো চ্যানেল পাওয়া যায়নি";
                }
            })
            .catch(err => {
                console.error("প্লেলিস্ট লোড করতে সমস্যা:", err);
                document.getElementById('title').innerText = "প্লেলিস্ট লোড ব্যর্থ হয়েছে";
            });
    } else {
        document.getElementById('title').innerText = "লিংকে প্লেলিস্ট অ্যাড করুন";
    }
</script>

</body>
</html>
